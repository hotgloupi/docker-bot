# vim: set filetype=python expandtab
from __future__ import absolute_import

from buildbot.changes.gitpoller import GitPoller
from buildbot.changes import filter
from buildbot.config import BuilderConfig
from buildbot.plugins import buildslave
from buildbot.process.factory import BuildFactory
from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.schedulers.timed import Nightly
from buildbot.schedulers.triggerable import Triggerable
from buildbot.steps.source.git import Git
from buildbot.steps.transfer import FileDownload
from buildbot.steps.shell import ShellCommand

from collections import namedtuple
import json
import os

from dockerslave import DockerLatentBuildSlave

SLAVE_PASSWORD = 'lolthisissecure'

def byteify(input):
    if isinstance(input, dict):
        return {byteify(key):byteify(value) for key,value in input.iteritems()}
    elif isinstance(input, list):
        return [byteify(element) for element in input]
    elif isinstance(input, unicode):
        return input.encode('utf-8')
    else:
        return input

with open('description.json') as f:
    DESCRIPTION = byteify(json.load(f))
    print("DESCRTIPTION:", DESCRIPTION)

SLAVES = DESCRIPTION['slaves']

c = BuildmasterConfig = {}

def file_content(path, **kw):
    with open(path) as f:
        return f.read().format(**kw)

c['slaves'] = [
    DockerLatentBuildSlave(
        name,
        SLAVE_PASSWORD,
        docker_host = slave['docker-host'],
        dockerfile = file_content(
            slave['docker-file'],
            master_hostname = '%(server-address)s:%(server-port)s' % DESCRIPTION['master'],
            slave_name = name,
            slave_password = SLAVE_PASSWORD,
        ),
        version = '1.12',
    ) for name, slave in SLAVES.items()
]

c['protocols'] = {'pb': {'port': 9989}}

c['change_source'] = [
    GitPoller(
        DESCRIPTION['repository']['url'],
        workdir = 'gitpoller-workdir',
        branch = 'master',
        pollinterval = 30
    )
]

BUILDS = DESCRIPTION['builds']

BUILD_NAMES = list(map(str, BUILDS.keys()))

print(BUILD_NAMES)

c['schedulers'] = [
    SingleBranchScheduler(
        name = "all",
        change_filter = filter.ChangeFilter(branch = 'master'),
        treeStableTimer = None,
        builderNames = BUILD_NAMES,
    ),
    ForceScheduler(
        name = "force",
        builderNames = BUILD_NAMES,
    ),
]

c['builders'] = []
for name, build in BUILDS.items():
    factory = BuildFactory()
    print(DESCRIPTION['repository']['url'])
    factory.addStep(
        Git(
            repourl = DESCRIPTION['repository']['url'],
            mode = 'incremental',
            # method = 'fresh', # only with full mode
            submodules = True,
            alwaysUseLatest = True,
            shallow = False,
        )
    )
    for step in build['steps']:
        factory.addStep(
            FileDownload(
                mastersrc = os.path.join('scripts', step),
                slavedest = step
            )
        )
        factory.addStep(
            ShellCommand(
                ['sh', step]
            )
        )
    c['builders'].append(
        BuilderConfig(
            name = name,
            slavenames = build['slaves'],
            factory = factory
        )
    )

c['status'] = []


from buildbot.status import html
from buildbot.status.web import authz, auth

c['status'].append(
    html.WebStatus(
        #http_port = "tcp:8010:interface=127.0.0.1",
        http_port = 8010,
        authz = authz.Authz(
            # authentication handled by nginx
            #auth = auth.BasicAuth([
            #    ("bf","bfpasslol"),
            #]),
            gracefulShutdown = False,
            forceBuild = True,
            forceAllBuilds = False,
            pingBuilder = True,
            stopBuild = True,
            stopAllBuilds = False,
            cancelPendingBuild = False,
        ),
        change_hook_dialects = {'github': True},
    )
)

####### PROJECT IDENTITY

c['title'] = "8cube"
c['titleURL'] = "http://8cube.io"
c['buildbotURL'] = "http://bf.8cube.io"
c['buildbotURL'] = "http://localhost:8010/"

